version: '3.8'

x-common-config: &common-config
  image: img_description:${IMAGE_TAG:-latest}
  environment:
    - PYTHONUNBUFFERED=1
    - qwen_api=${qwen_api}
    - DEPT_ID=${DEPT_ID:-10}
    - FETCH_TIME_RANGE_HOURS=${FETCH_TIME_RANGE_HOURS:-24}

  volumes:
    - ./models:/app/models:ro
    - ./scripts:/app/scripts:ro
    - ./config.yaml:/app/config.yaml:ro
    - /home/data/pics/AI/:/app/output
    - ./images:/app/images
    - ./logs:/app/logs
    - ./prompt_chinese.txt:/app/prompt_chinese.txt
    - ./prompt_english.txt:/app/prompt_english.txt

  working_dir: /app
  deploy:
    resources:
      limits:
        memory: 4G
      reservations:
        memory: 2G
  restart: unless-stopped
  network_mode: "host"
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

services:
  # Build service - builds the image once
  image-builder:
    build:
      context: .
      dockerfile: Dockerfile
    image: img_description:${IMAGE_TAG:-latest}
    profiles:
      - build

  image-description-as00213:
    <<: *common-config
    container_name: image-description-as00213
    environment:
      - ROBOT_NAME=as00213
      - API_BASE_URL=https://hk1.aimo.tech/
      - API_USERNAME=${API_USERNAME_HK}
      - API_PASSWORD=${API_PASSWORD_HK}
      - LANGUAGE=english
    command: ["python", "/app/scripts/image_description.py"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        tag: "image-description-as00213"

  image-description-as00107:
    <<: *common-config
    container_name: image-description-as00107
    environment:
      - ROBOT_NAME=as00107
      - API_BASE_URL=https://hk1.aimo.tech/
      - API_USERNAME=${API_USERNAME_HK}
      - API_PASSWORD=${API_PASSWORD_HK}
      - LANGUAGE=chinese
    command: ["python", "/app/scripts/image_description.py"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        tag: "image-description-as00107"

  image-description-as00122:
    <<: *common-config
    container_name: image-description-as00122
    environment:
      - ROBOT_NAME=as00122
      - API_BASE_URL=https://hk1.aimo.tech/
      - API_USERNAME=${API_USERNAME_HK}
      - API_PASSWORD=${API_PASSWORD_HK}
      - LANGUAGE=chinese
    command: ["python", "/app/scripts/image_description.py"]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        tag: "image-description-as00122"

volumes:
  output:
